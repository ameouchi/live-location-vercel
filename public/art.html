<!DOCTYPE html>
<html>
<head>
  <title>Map â€“ Shared Locations + Layers</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; left: 220px; right: 0; filter: invert(1) hue-rotate(180deg); }
    #sidebar {
      position: absolute; top: 0; left: 0; bottom: 0; width: 220px;
      background: rgba(255,255,255,0.95); padding: 10px; overflow-y: auto;
      z-index: 998; border-right: 1px solid #ccc;
    }
    #sidebar h3 { margin-top: 0; font-size: 16px; }
    #peopleList { list-style: none; padding: 0; margin: 0; }
    #peopleList li { padding: 4px 0; font-size: 14px; border-bottom: 1px solid #eee; }
    .layerToggle, .controlBtn {
      position: absolute; top: 20px; padding: 6px 12px;
      background: white; border: 1px solid #ccc; z-index: 999; cursor: pointer;
    }
    #startBtn { left: 240px; }
    #stopBtn { left: 340px; }
    #drawToggle { left: 440px; }
    #bedrockToggle { left: 560px; }
    #v2Toggle { left: 660px; }
    #v3Toggle { left: 760px; }
  </style>
</head>
<body>

<div id="sidebar">
  <h3>Shared Locations</h3>
  <ul id="peopleList"></ul>
</div>

<div id="map"></div>
<button id="startBtn" class="controlBtn">Start</button>
<button id="stopBtn" class="controlBtn">Stop</button>
<button id="drawToggle" class="controlBtn">Draw: OFF</button>
<button id="bedrockToggle" class="layerToggle">Bedrock: ON</button>
<button id="v2Toggle" class="layerToggle">V2: ON</button>
<button id="v3Toggle" class="layerToggle">V3: ON</button>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibGFtZW91Y2hpIiwiYSI6ImNsa3ZqdHZtMDBjbTQzcXBpNzRyc2ljNGsifQ.287002jl7xT9SBub-dbBbQ';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/lameouchi/cme04okvl00be01rydkfj6r43',
  center: [-71.12953, 42.34836],
  zoom: 16
});

let bedrockZones = [], zoneFlags = [], sounds = [], audioBuffers = [], drawCoords = [];
let audioContext, drawMode = false, intervalId = null;

function toggleLayer(id, btnId, label) {
  const vis = map.getLayoutProperty(id, 'visibility') || 'visible';
  const newVis = vis === 'visible' ? 'none' : 'visible';
  map.setLayoutProperty(id, 'visibility', newVis);
  const labelLayer = map.getLayer(`${id}-labels`);
  if (labelLayer) map.setLayoutProperty(`${id}-labels`, 'visibility', newVis);
  document.getElementById(btnId).textContent = `${label}: ${newVis === 'visible' ? 'ON' : 'OFF'}`;
}

async function loadSound(url) {
  const response = await fetch(url);
  const arrayBuffer = await response.arrayBuffer();
  return await audioContext.decodeAudioData(arrayBuffer);
}

async function loadGeojsonLayer(id, url, colors) {
  const data = await fetch(url).then(res => res.json());
  const values = data.features.map(f => f.properties.DN).filter(v => typeof v === 'number');
  const [min, max] = [Math.min(...values), Math.max(...values)];
  const mid = (min + max) / 2;
  map.addSource(id, { type: 'geojson', data });
  map.addLayer({
    id,
    type: 'fill',
    source: id,
    paint: {
      'fill-color': ['interpolate', ['linear'], ['get', 'DN'], min, colors[0], mid, colors[1], max, colors[2]],
      'fill-opacity': 0.5,
      'fill-outline-color': '#000'
    }
  });
}

map.on('load', async () => {
  // Load Bedrock
  const bedrock = await fetch('bedrock_depth_vector.geojson').then(res => res.json());
  bedrockZones = bedrock.features;
  const values = bedrockZones.map(f => f.properties.DN);
  const [min, max] = [Math.min(...values), Math.max(...values)];
  const mid = (min + max) / 2;
  zoneFlags = new Array(bedrockZones.length).fill(false);
  sounds = new Array(bedrockZones.length).fill(null);

  map.addSource('bedrock', { type: 'geojson', data: bedrock });
  map.addLayer({
    id: 'bedrock',
    type: 'fill',
    source: 'bedrock',
    paint: {
      'fill-color': ['interpolate', ['linear'], ['get', 'DN'], min, '#FF0000', mid, '#FFFFFF', max, '#0000FF'],
      'fill-opacity': 0.6,
      'fill-outline-color': '#000'
    }
  });

  // Bedrock Labels
  const labelFeatures = bedrockZones.map(f => {
    const center = turf.centroid(f);
    center.properties.label = `DN: ${f.properties.DN}`;
    return center;
  });
  map.addSource('bedrock-labels', { type: 'geojson', data: { type: 'FeatureCollection', features: labelFeatures } });
  map.addLayer({
    id: 'bedrock-labels',
    type: 'symbol',
    source: 'bedrock-labels',
    layout: {
      'text-field': ['get', 'label'],
      'text-size': 11
    },
    paint: {
      'text-color': '#111',
      'text-halo-color': '#fff',
      'text-halo-width': 1
    }
  });

  // Load V2 + V3
  await loadGeojsonLayer('v2layer', 'v2.geojson', ['#008000', '#FFFF00', '#8B4513']);
  await loadGeojsonLayer('v3layer', 'v3.geojson', ['#800080', '#FFC0CB', '#00FFFF']);

  // Simulated Line
  map.addSource('live-lines', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
  map.addLayer({
    id: 'live-lines',
    type: 'line',
    source: 'live-lines',
    paint: { 'line-color': '#FF0000', 'line-width': 4 }
  });

  map.on('click', e => {
    if (!drawMode) return;
    drawCoords.push(e.lngLat.toArray());
    const feature = {
      type: 'Feature',
      geometry: { type: 'LineString', coordinates: drawCoords },
      properties: { name: 'SimUser' }
    };
    map.getSource('live-lines').setData({ type: 'FeatureCollection', features: [feature] });
  });
});

document.getElementById('drawToggle').addEventListener('click', () => {
  drawMode = !drawMode;
  document.getElementById('drawToggle').textContent = `Draw: ${drawMode ? 'ON' : 'OFF'}`;
});

document.getElementById('startBtn').addEventListener('click', async () => {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    await Promise.all(bedrockZones.map(async (f, i) => {
      try {
        audioBuffers[i] = await loadSound(`/zone_sound${f.properties.DN}.mp3`);
      } catch {
        audioBuffers[i] = null;
      }
    }));
  }
  if (!intervalId) intervalId = setInterval(updateMap, 3000);
});

document.getElementById('stopBtn').addEventListener('click', () => {
  clearInterval(intervalId);
  intervalId = null;
  drawCoords = [];
  map.getSource('live-lines').setData({ type: 'FeatureCollection', features: [] });
  zoneFlags.forEach((_, i) => {
    if (sounds[i]) {
      sounds[i].stop();
      sounds[i] = null;
    }
    zoneFlags[i] = false;
  });
  document.getElementById('peopleList').innerHTML = '';
});

async function updateMap() {
  const data = map.getSource('live-lines')._data;
  if (!data || data.features.length === 0) return;
  const pt = turf.point(drawCoords[drawCoords.length - 1]);
  document.getElementById('peopleList').innerHTML = `<li>SimUser</li>`;

  bedrockZones.forEach((zone, i) => {
    const inside = turf.booleanPointInPolygon(pt, zone);
    if (inside && !zoneFlags[i] && audioBuffers[i]) {
      const source = audioContext.createBufferSource();
      source.buffer = audioBuffers[i];
      source.loop = true;
      source.connect(audioContext.destination);
      source.start(0);
      sounds[i] = source;
      zoneFlags[i] = true;
    } else if (!inside && zoneFlags[i]) {
      sounds[i]?.stop();
      sounds[i] = null;
      zoneFlags[i] = false;
    }
  });
}

document.getElementById('bedrockToggle').onclick = () => toggleLayer('bedrock', 'bedrockToggle', 'Bedrock');
document.getElementById('v2Toggle').onclick = () => toggleLayer('v2layer', 'v2Toggle', 'V2');
document.getElementById('v3Toggle').onclick = () => toggleLayer('v3layer', 'v3Toggle', 'V3');
</script>
</body>
</html>
