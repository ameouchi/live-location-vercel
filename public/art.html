<!DOCTYPE html>
<html>
<head>
  <title>Map â€“ Simulation & Layers</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; left: 220px; right: 0; filter: invert(1) hue-rotate(180deg); }
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 220px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      overflow-y: auto;
      z-index: 998;
      border-right: 1px solid #ccc;
    }
    #sidebar h3 { margin-top: 0; font-size: 16px; }
    #peopleList { list-style: none; padding: 0; margin: 0; }
    #peopleList li { padding: 4px 0; font-size: 14px; border-bottom: 1px solid #eee; }
    .layerToggle, .drawBtn {
      position: absolute;
      top: 20px;
      padding: 6px 12px;
      background: white;
      border: 1px solid #ccc;
      z-index: 999;
      cursor: pointer;
      margin-right: 8px;
    }
    #bedrockToggle { left: 340px; }
    #v2Toggle { left: 440px; }
    #v3Toggle { left: 540px; }
    #drawBtn { left: 640px; }
    #clearBtn { left: 740px; }
  </style>
</head>
<body>

  <div id="sidebar">
    <h3>Shared Locations</h3>
    <ul id="peopleList"></ul>
    <button id="startBtn">â–¶ Start Simulation</button>
  </div>
  

<div id="map"></div>

<button id="bedrockToggle" class="layerToggle">Bedrock: ON</button>
<button id="v2Toggle" class="layerToggle">V2: ON</button>
<button id="v3Toggle" class="layerToggle">V3: ON</button>
<button id="drawBtn" class="drawBtn">Draw Line</button>
<button id="clearBtn" class="drawBtn">Clear</button>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibGFtZW91Y2hpIiwiYSI6ImNsa3ZqdHZtMDBjbTQzcXBpNzRyc2ljNGsifQ.287002jl7xT9SBub-dbBbQ';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/lameouchi/cme04okvl00be01rydkfj6r43',
  center: [-71.12953, 42.34836],
  zoom: 16
});

let bedrockZones = [], zoneFlags = [], sounds = [], audioBuffers = [];
let audioContext;
let drawnCoords = [];
let isDrawing = false;

async function loadSound(url) {
  const res = await fetch(url);
  const buf = await res.arrayBuffer();
  return await audioContext.decodeAudioData(buf);
}

map.on('load', async () => {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();

  const loadGeo = async (file) => (await fetch(file)).json();

  const bedrock = await loadGeo('bedrock_depth_vector.geojson');
  bedrockZones = bedrock.features;
  const bedrockDNs = bedrockZones.map(f => f.properties.DN).filter(Number.isFinite);
  const [minDN, maxDN] = [Math.min(...bedrockDNs), Math.max(...bedrockDNs)];
  const midDN = (minDN + maxDN) / 2;

  zoneFlags = new Array(bedrockZones.length).fill(false);
  sounds = new Array(bedrockZones.length).fill(null);
  audioBuffers = await Promise.all(
    bedrockZones.map(f => loadSound(`/zone_sound${f.properties.DN}.mp3`).catch(() => null))
  );

  map.addSource('bedrock', { type: 'geojson', data: bedrock });
  map.addLayer({
    id: 'bedrock',
    type: 'fill',
    source: 'bedrock',
    paint: {
      'fill-color': ['interpolate', ['linear'], ['get', 'DN'], minDN, '#FF0000', midDN, '#FFFFFF', maxDN, '#0000FF'],
      'fill-opacity': 0.6, 'fill-outline-color': '#000'
    }
  });

  // V2 Layer
  const v2 = await loadGeo('v2.geojson');
  const v2DNs = v2.features.map(f => f.properties.DN).filter(Number.isFinite);
  const [min2, max2] = [Math.min(...v2DNs), Math.max(...v2DNs)];
  const mid2 = (min2 + max2) / 2;

  map.addSource('v2layer', { type: 'geojson', data: v2 });
  map.addLayer({
    id: 'v2layer',
    type: 'fill',
    source: 'v2layer',
    paint: {
      'fill-color': ['interpolate', ['linear'], ['get', 'DN'], min2, '#008000', mid2, '#FFFF00', max2, '#8B4513'],
      'fill-opacity': 0.4, 'fill-outline-color': '#000'
    }
  });

  // V3 Layer
  const v3 = await loadGeo('v3.geojson');
  const v3DNs = v3.features.map(f => f.properties.DN).filter(Number.isFinite);
  const [min3, max3] = [Math.min(...v3DNs), Math.max(...v3DNs)];
  const mid3 = (min3 + max3) / 2;

  map.addSource('v3layer', { type: 'geojson', data: v3 });
  map.addLayer({
    id: 'v3layer',
    type: 'fill',
    source: 'v3layer',
    paint: {
      'fill-color': ['interpolate', ['linear'], ['get', 'DN'], min3, '#800080', mid3, '#FFC0CB', max3, '#00FFFF'],
      'fill-opacity': 0.4, 'fill-outline-color': '#000'
    }
  });

  // Live Lines
  map.addSource('live-lines', {
    type: 'geojson',
    data: { type: "FeatureCollection", features: [] }
  });
  map.addLayer({
    id: 'live-lines',
    type: 'line',
    source: 'live-lines',
    paint: {
      'line-color': '#FF0000',
      'line-width': 4
    }
  });

  map.fitBounds(turf.bbox(bedrock), { padding: 20 });
});

// Toggle layer
function toggleLayer(id, btnId, label) {
  const vis = map.getLayoutProperty(id, 'visibility') || 'visible';
  const newVis = vis === 'visible' ? 'none' : 'visible';
  map.setLayoutProperty(id, 'visibility', newVis);
  document.getElementById(btnId).textContent = `${label}: ${newVis === 'visible' ? 'ON' : 'OFF'}`;
}
document.getElementById('bedrockToggle').onclick = () => toggleLayer('bedrock', 'bedrockToggle', 'Bedrock');
document.getElementById('v2Toggle').onclick = () => toggleLayer('v2layer', 'v2Toggle', 'V2');
document.getElementById('v3Toggle').onclick = () => toggleLayer('v3layer', 'v3Toggle', 'V3');

document.getElementById('startBtn').onclick = async () => {
  // Resume the AudioContext to allow sound playback
  if (audioContext.state === 'suspended') {
    await audioContext.resume();
    console.log('ðŸ”Š AudioContext resumed');
  }

  updateSimulation();
  setInterval(updateSimulation, 3000);
};


// DRAW TOOL
map.on('click', (e) => {
  if (!isDrawing) return;
  drawnCoords.push([e.lngLat.lng, e.lngLat.lat]);
  const line = {
    type: "FeatureCollection",
    features: [{
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: drawnCoords
      }
    }]
  };
  map.getSource('live-lines').setData(line);
});

document.getElementById('drawBtn').onclick = () => {
  isDrawing = true;
  drawnCoords = [];
};

document.getElementById('clearBtn').onclick = () => {
  isDrawing = false;
  drawnCoords = [];
  map.getSource('live-lines').setData({ type: "FeatureCollection", features: [] });
  stopAllSounds();
};

function stopAllSounds() {
  sounds.forEach((src, i) => {
    if (src) {
      src.stop();
      src.disconnect();
      sounds[i] = null;
      zoneFlags[i] = false;
    }
  });
}

function updateSimulation() {
  if (drawnCoords.length === 0) return;
  const pt = turf.point(drawnCoords[drawnCoords.length - 1]);

  bedrockZones.forEach((feature, i) => {
    const poly = turf.polygon(feature.geometry.coordinates);
    const isInside = turf.booleanPointInPolygon(pt, poly);

    if (isInside && !zoneFlags[i] && audioBuffers[i]) {
      const src = audioContext.createBufferSource();
      src.buffer = audioBuffers[i];
      src.loop = true;
      src.connect(audioContext.destination);
      src.start();
      sounds[i] = src;
      zoneFlags[i] = true;
    } else if (!isInside && zoneFlags[i]) {
      if (sounds[i]) {
        sounds[i].stop();
        sounds[i].disconnect();
        sounds[i] = null;
      }
      zoneFlags[i] = false;
    }
  });
}
</script>
</body>
</html>
