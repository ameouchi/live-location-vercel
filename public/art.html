<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Geofence Sound Zones</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/deck.gl@8.9.27/dist.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #map { position: absolute; width: 100vw; height: 100vh; }
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 16px 32px;
      font-size: 18px;
      background-color: black;
      color: white;
      border: none;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="startButton">Start</button>
  <script>
    const accessToken = 'pk.eyJ1IjoiZ2FieWNhcnUiLCJhIjoiY203dzI5eTRpMDExeDJqcHk0a2JjaWp4diJ9.Voohpst6Zz-ZN7MZ_M3BUw';
    mapboxgl.accessToken = accessToken;

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/gabycaru/cm8d60fxc00rg01s5hlv55yn1?optimize=true',
      center: [-71.12959099075543, 42.34826632541306],
      zoom: 18
    });

    const ZONE_A = turf.polygon([[
      [-71.12966, 42.34822],
      [-71.12952, 42.34822],
      [-71.12952, 42.34831],
      [-71.12966, 42.34831],
      [-71.12966, 42.34822]
    ]]);

    const ZONE_B = turf.polygon([[
      [-71.12952, 42.34822],
      [-71.12938, 42.34822],
      [-71.12938, 42.34831],
      [-71.12952, 42.34831],
      [-71.12952, 42.34822]
    ]]);

    const zones = [
      { polygon: ZONE_A, color: [255, 0, 0], sound: new Audio('https://www.soundjay.com/button/beep-07.mp3') },
      { polygon: ZONE_B, color: [0, 0, 255], sound: new Audio('https://www.soundjay.com/button/beep-08b.mp3') }
    ];

    let userLocation = null;
    let lastZoneIndex = null;

    const overlay = new deck.MapboxOverlay({
      get layers() {
        const zoneLayers = zones.map((z, i) =>
          new deck.PolygonLayer({
            id: `zone-${i}`,
            data: [z.polygon],
            getPolygon: f => f.geometry.coordinates,
            getLineColor: z.color,
            getLineWidth: 3,
            lineWidthMinPixels: 2,
            stroked: true,
            filled: false
          })
        );

        const dotLayer = userLocation
          ? new deck.ScatterplotLayer({
              id: 'user-dot',
              data: [userLocation],
              getPosition: d => d,
              getRadius: 6,
              getFillColor: [255, 0, 0],
              radiusMinPixels: 6
            })
          : null;

        return [...zoneLayers, ...(dotLayer ? [dotLayer] : [])];
      }
    });

    map.on('load', () => {
      map.addControl(overlay);
    });

    document.getElementById('startButton').addEventListener('click', () => {
      document.getElementById('startButton').style.display = 'none';

      // Unlock audio context by calling play once
      zones.forEach(z => z.sound.play().then(() => z.sound.pause()));

      navigator.geolocation.watchPosition(pos => {
        const coords = [pos.coords.longitude, pos.coords.latitude];
        const point = turf.point(coords);
        userLocation = coords;

        let insideIndex = null;
        zones.forEach((z, i) => {
          if (turf.booleanPointInPolygon(point, z.polygon)) {
            insideIndex = i;
          }
        });

        if (insideIndex !== null && insideIndex !== lastZoneIndex) {
          zones[insideIndex].sound.play();
          lastZoneIndex = insideIndex;
        }

        if (insideIndex === null) {
          lastZoneIndex = null;
        }

        overlay.setProps({});
      }, err => {
        console.error('Geolocation error:', err);
      }, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 5000
      });
    });
  </script>
</body>
</html>
